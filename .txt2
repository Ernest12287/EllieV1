

# ü§ñ Project: EllieV1 Self-Update Module

## Agent Coder Instruction Manual for `update.js`

**Objective:** Create a self-contained bot command, `update.js`, that fetches the latest command files from the GitHub repository and forces a self-restart, effectively "syncing" the bot's code without requiring `git pull` or `npm install`.

**Constraint Summary:**

  * Bot runs via `node main.js` (obfuscated entry file).
  * No external terminal access (`git`, `pm2`, shell commands) is possible.
  * New NPM dependencies (changes to `package.json`) **must be avoided**.

-----

## 1\. ‚öôÔ∏è Technical Requirements & File Updates

| File/Requirement | Detail | Action for Agent |
| :--- | :--- | :--- |
| **`package.json`** | **Critical:** Must include `node-fetch` and `path` for file system operations. If `node-fetch` is not currently installed, the Agent must ensure it is added. | **Update:** Verify `dependencies` includes `node-fetch` (or a similar client like `axios`) and `path`. |
| **`.env` or Config File** | The GitHub Personal Access Token (PAT) must be stored securely to authorize API requests. The PAT must have **`repo`** scope (or **`contents:read`** for fine-grained tokens). | **New Variable:** Add `GITHUB_PAT` to the bot's environment/config file. |
| **`index.js` (or `main.js`)** | The bot's main file needs to load the `GITHUB_PAT` and pass it to the command handler/environment. | **Update:** Ensure `GITHUB_PAT` is accessible as `process.env.GITHUB_PAT`. |
| **Target Directories** | The script must know the local paths to update. Example paths assumed below. | **Update:** Define local paths for target directories (e.g., `commands`, `handlers`). |

-----

## 2\. üìù `update.js` Suggested Workflow

The `update.js` file will be an asynchronous function that runs when a specific command (e.g., `!update`) is triggered.

### Phase 1: Preparation and Configuration

1.  **Constants:** Define all necessary constants and modules.

    ```javascript
    const fs = require('fs');
    const path = require('path');
    const fetch = require('node-fetch'); // or axios, if preferred/installed
    // Define the base URL for the GitHub API
    const API_BASE = 'https://api.github.com/repos/Ernest12287/EllieV1/contents/';
    // Get the PAT from the environment variable
    const GITHUB_TOKEN = process.env.GITHUB_PAT; 
    // Define directories to update and their corresponding local paths
    const TARGET_DIRS = [
        { remote: 'commands', local: path.join(__dirname, '..', 'commands') },
        // Add other folders like 'handlers' if they also need self-updates
        // { remote: 'handlers', local: path.join(__dirname, '..', 'handlers') }
    ];
    ```

2.  **Authentication Check:** Immediately fail if the necessary token is missing.

### Phase 2: Fetch and Update Logic (Iterative)

The core logic should iterate through all `TARGET_DIRS` and update their contents.

**A. Get Remote Directory Contents**

  * For each directory in `TARGET_DIRS`, make an authenticated GET request to the GitHub API:
    ```javascript
    // Example for 'commands' folder
    const apiUrl = API_BASE + 'commands';
    const headers = {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'User-Agent': 'EllieV1-Updater' // Required by GitHub API
    };

    const response = await fetch(apiUrl, { headers });
    if (!response.ok) {
        throw new Error(`GitHub API error: ${response.statusText}`);
    }
    const remoteFiles = await response.json(); 
    ```

**B. Download and Overwrite Files**

  * Filter the `remoteFiles` array to include only items where `type` is **`file`**.
  * Iterate over the filtered array. For each file, perform the following:
    1.  Get the file's raw content URL (`remoteFile.download_url`).
    2.  Fetch the raw content (a simple text request).
    3.  Construct the local file path: `path.join(localPath, remoteFile.name)`.
    4.  Use `fs.writeFileSync()` (synchronous is safer here to ensure integrity) to overwrite the local file content.

> **Crucial Note:** Handle errors during download or writing. If a single file fails, log the error but continue to the next, then report the overall failure at the end.

### Phase 3: Synchronization and Self-Restart

After ALL target directories are processed and files are successfully written, initiate the self-restart.

1.  **Confirmation:** Send a successful update message to the user/channel.
2.  **Exit:** Use `process.exit(0)` to gracefully terminate the bot process, relying on the Katabump/Hosting Panel's auto-restart feature to start the new, updated process.

<!-- end list -->

```javascript
// Final step of the update command
console.log('[UPDATE] All files written. Initiating self-restart for synchronization...');
// Give the bot a small delay to finish sending logs/messages before exit
await new Promise(resolve => setTimeout(resolve, 1500)); 
process.exit(0);
```

-----

## 3\. üõ°Ô∏è Security Advice (Must Implement)

1.  **Permission Check:** The `update.js` command **must** have a robust check to ensure it can **only** be triggered by the bot owner (Ernest, based on the user context) or an authorized administrator. **Never expose this command publicly.**
2.  **Token Security:** Ensure the `GITHUB_PAT` is loaded from an environment variable (`.env` file) and is **not hardcoded** anywhere in the code that might be pushed to the public repo.

This workflow is the most effective and secure way to handle code synchronization in a restricted hosting environment without shell access.
